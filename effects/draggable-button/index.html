<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>可拖动按钮</title>
  <style>
    body {
      margin: 0;
    }

    #draggable_button {
      display: block;
      text-align: center;
      width: 56px;
      height: 56px;
      line-height: 56px;
      color: #fff;
      background: royalblue;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      overflow: hidden;
      position: fixed;
      z-index: 10000;
      right: 20px;
      bottom: 20px;
      cursor: pointer;
    }
  </style>

  <script src="https://cdn.staticfile.org/vConsole/3.3.2/vconsole.min.js"></script>
  <script>var vConsole = new VConsole();</script>
</head>
<body>
<div id="draggable_button">拖动</div>
<script>

  function setDraggable(id, callback) {
    var dragEl = document.getElementById('draggable_button');
    var initX, initY, initXOffset, initYOffset;
    var isClick;  // 判断是点击还是拖动

    dragEl.addEventListener('touchstart', function (e) {
      e.preventDefault();
      isClick = true;

      initX = e.touches[0].clientX;
      initY = e.touches[0].clientY;

      initXOffset = initX - this.offsetLeft;
      initYOffset = initY - this.offsetTop;

      this.style.opacity = '0.5';
      console.log('touchstart');
    })

    dragEl.addEventListener('touchmove', function (e) {
      var touchX = e.touches[0].clientX;
      var touchY = e.touches[0].clientY;
      var curX = touchX - initXOffset;
      var curY = touchY - initYOffset;

      // 限制出框
      var docWidth = document.documentElement.clientWidth - this.clientWidth
      var docHeight = document.documentElement.clientHeight - this.clientHeight
      curX = Math.min(docWidth, Math.max(0, curX));
      curY = Math.min(docHeight, Math.max(0, curY));

      // 忽略轻微移动
      var offsetX = Math.abs(touchX - initX)
      var offsetY = Math.abs(touchY - initY)
      console.log(offsetX, offsetY)
      if (offsetX <= 1 || offsetY <= 1) {
      } else {
        isClick = false;
      }

      this.style.left = curX + 'px';
      this.style.top = curY + 'px';

      console.log('touchmove');
    })

    dragEl.addEventListener('touchend', function (e) {
      this.style.opacity = '1'

      if (isClick) {
        console.log('click!');
        callback(e)
      }
      console.log('touchend');
    })
  }

  setDraggable('draggable_button', function (e) {
    alert(e)
  })

</script>
</body>
</html>
